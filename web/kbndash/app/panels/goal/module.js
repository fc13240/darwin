/*! kibana - v3.1.2 - 2015-07-29
 * Copyright (c) 2015 Rashid Khan; Licensed Apache License */

define("panels/goal/module",["angular","app","lodash","jquery","kbn","config","chromath"],function(a,b,c,d,e){"use strict";var f=a.module("kibana.panels.goal",[]);b.useModule(f),f.controller("goal",["$scope","$rootScope","querySrv","dashboard","filterSrv","colorsSvr",function(b,d,e,f,g,h){b.panelMeta={editorTabs:[{title:"Queries",src:"app/partials/querySelect.html"}],modals:[{description:"Inspect",icon:"icon-info-sign",partial:"app/partials/inspector.html",show:b.panel.spyable}]};var i={donut:!0,tilt:!1,legend:"above",labels:!0,spyable:!0,query:{goal:100},queries:{mode:"all",ids:[]}};c.defaults(b.panel,i),b.init=function(){b.$on("refresh",function(){b.get_data()}),b.get_data()},b.set_refresh=function(a){b.refresh=a},b.close_edit=function(){b.refresh&&b.get_data(),b.refresh=!1,b.$emit("render")},b.get_data=function(){if(0!==f.indices.length){b.panelMeta.loading=!0;var d=b.ejs.Request().indices(f.indices);b.panel.queries.ids=e.idsByMode(b.panel.queries);var i=e.getQueryObjs(b.panel.queries.ids),j=b.ejs.BoolQuery();c.each(i,function(a){j=j.should(e.toEjsObj(a))});var k;d=d.query(j).filter(g.getBoolFilter(g.ids())).size(0),b.inspector=a.toJson(JSON.parse(d.toString()),!0),k=d.doSearch(),k.then(function(c){console.log("goal"),console.log(a.toJson(c)),b.panelMeta.loading=!1;var d=c.hits.total,e=b.panel.query.goal-d;b.data=[{label:"Complete",data:d,color:h.colors[parseInt(b.$id,16)%8]},{data:e,color:Chromath.lighten(h.colors[parseInt(b.$id,16)%8],.7).toString()}],b.$emit("render")})}}}]),f.directive("goal",["querySrv",function(a){return{restrict:"A",link:function(a,b){function f(){b.css({height:a.panel.height||a.row.height});var e;e={show:a.panel.labels,radius:0,formatter:function(b,d){var e=parseInt((a.panel.height||a.row.height).replace("px",""),10)/8+String("px");return c.isUndefined(b)?"":'<div style="font-size:'+e+';font-weight:bold;text-align:center;padding:2px;color:#fff;">'+Math.round(d.percent)+"%</div>"}};var f={series:{pie:{innerRadius:a.panel.donut?.45:0,tilt:a.panel.tilt?.45:1,radius:1,show:!0,combine:{color:"#999",label:"The Rest"},label:e,stroke:{width:0}}},grid:{backgroundColor:null,hoverable:!0,clickable:!0},legend:{show:!1},colors:colorsSvr.colors};b.is(":visible")&&require(["jquery.flot.pie"],function(){a.legend=d.plot(b,a.data,f).getData(),a.$$phase||a.$apply()})}b.html('<center><img src="img/load_big.gif"></center>'),a.$on("render",function(){f()});var g=d("<div>");b.bind("plothover",function(a,b,c){c?g.html([e.query_color_dot(c.series.color,15),c.series.label||"",parseFloat(c.series.percent).toFixed(1)+"%"].join(" ")).place_tt(b.pageX,b.pageY,{offset:10}):g.remove()})}}}])});