/*! kibana - v3.1.2 - 2015-12-18
 * Copyright (c) 2015 Rashid Khan; Licensed Apache License */

define("panels/terms/module",["angular","app","lodash","jquery","kbn","html2canvas","div2png"],function(a,b,c,d,e){"use strict";var f=a.module("kibana.panels.terms",[]);b.useModule(f),f.controller("terms",["$scope","querySrv","dashboard","filterSrv","fields","$filter",function(b,d,e,f,g,h){b.export_panel=function(a){div2png("terms")},b.dictionaryInfo=e.current.filed_dic.dictionaryInfo,b.panelMeta={modals:[{description:"Inspect",icon:"icon-info-sign",partial:"app/partials/inspector.html",show:b.panel.spyable}]};var i={isFilter:!1,localFilter:"",field:"_type",exclude:[],missing:!1,other:!1,size:10,order:"count",orderX:"desc",style:{"font-size":"10pt"},donut:!1,tilt:!1,labels:!0,arrangement:"horizontal",chart:"bar",counter_pos:"above",spyable:!0,queries:{mode:"all",ids:[]},tmode:"terms",tstat:"total",valuefield:""};c.defaults(b.panel,i),b.init=function(){b.hits=0,b.$on("refresh",function(){b.get_data()}),b.get_data()},b.keyvalues=e.current.filed_dic.keyvalues,b.dscolumns=e.current.filed_dic.dscolumns,b.get_data=function(){if(0!==e.indices.length){b.panelMeta.loading=!0;var h,i,j,k;b.field=c.contains(g.list,b.panel.field+".raw")?b.panel.field+".raw":b.panel.field,b.fieldmap=b.keyvalues[b.field],h=b.ejs.Request().indices(e.indices),b.panel.queries.ids=d.idsByMode(b.panel.queries),k=d.getQueryObjs(b.panel.queries.ids),j=b.ejs.BoolQuery(),c.each(k,function(a){var c="",e=a.query;1==b.panel.isFilter&&""!=b.panel.localFilter&&(c=a.query+" AND "+b.panel.localFilter,a.query=c),j=j.should(d.toEjsObj(a)),a.query=e}),"terms"===b.panel.tmode&&(h=h.facet(b.ejs.TermsFacet("terms").field(b.field).size(b.panel.size).order(b.panel.order).exclude(b.panel.exclude).facetFilter(b.ejs.QueryFilter(b.ejs.FilteredQuery(j,f.getBoolFilter(f.ids()))))).size(0)),"terms_stats"===b.panel.tmode&&(h=h.facet(b.ejs.TermStatsFacet("terms").valueField(b.panel.valuefield).keyField(b.field).size(b.panel.size).order(b.panel.order).facetFilter(b.ejs.QueryFilter(b.ejs.FilteredQuery(j,f.getBoolFilter(f.ids()))))).size(0)),b.inspector=a.toJson(JSON.parse(h.toString()),!0),i=h.doSearch(),i.then(function(a){"terms_stats"===b.panel.tmode,0==a.facets.terms.terms.length?b.isShowData=!0:b.isShowData=!1,b.panelMeta.loading=!1,"terms"===b.panel.tmode&&(b.hits=a.hits.total),b.results=a,b.$emit("render")})}},b.build_search=function(a,d){if(c.isUndefined(a.meta))f.set({type:"terms",field:b.field,value:a.label.key,mandate:d?"mustNot":"must"});else{if("missing"!==a.meta)return;f.set({type:"exists",field:b.field,mandate:d?"must":"mustNot"})}},b.set_refresh=function(a){b.refresh=a},b.close_edit=function(){b.refresh&&b.get_data(),b.refresh=!1,b.$emit("render")},b.showMeta=function(a){return c.isUndefined(a.meta)?!0:("other"!==a.meta||b.panel.other)&&("missing"!==a.meta||b.panel.missing)?!0:!1}}]),f.directive("termsChart",["querySrv","$filter",function(b,f){return{restrict:"A",link:function(g,h){function i(){var b=0;g.data=[],"terms"===g.panel.tmode&&(g.rawData=g.results.facets.terms.terms),"terms_stats"===g.panel.tmode&&("desc"==g.panel.orderX?g.rawData=g.results.facets.terms.terms.sort(j("desc",g.panel.tstat)):"asc"==g.panel.orderX?g.rawData=g.results.facets.terms.terms.sort(j("asc",g.panel.tstat)):g.rawData=g.results.facets.terms.terms),c.each(g.rawData,function(a){var c,d=g.fieldmap,e=f("textformatforstring")(a.term,d);"terms"===g.panel.tmode&&(c={label:e,data:[[b,a.count]],actions:!0}),"terms_stats"===g.panel.tmode&&(c={label:e,data:[[b,a[g.panel.tstat]]],actions:!0}),g.data.push(c),b+=1}),g.data.push({label:{key:"不匹配",value:"不匹配"},data:[[b,g.results.facets.terms.missing]],meta:"missing",color:"#aaa",opacity:0}),"terms"===g.panel.tmode&&g.data.push({label:{key:"其他",value:"其他"},data:[[b+1,g.results.facets.terms.other]],meta:"other",color:"#444"}),c.isUndefined(g.dictionaryInfo)||a.forEach(g.dictionaryInfo,function(b,c){a.forEach(g.data,function(a,c){a.label.value==b.key&&(a.label.value=b.value)})})}function j(a,b){var c="asc"==a?">":"<",d=new Function("a","b","return a."+b+c+"b."+b+"?1:-1");return console.log(),d}function k(){var e;i(),h.css({height:g.panel.height||g.row.height}),e=c.clone(g.data),e=g.panel.missing?e:c.without(e,c.findWhere(e,{meta:"missing"})),e=g.panel.other?e:c.without(e,c.findWhere(e,{meta:"other"})),require(["jquery.flot.pie"],function(){try{if("bar"===g.panel.chart&&(l=d.plot(h,e,{legend:{show:!1},series:{lines:{show:!1},bars:{show:!0,fill:1,barWidth:.8,horizontal:!1},shadowSize:1},yaxis:{show:!0,min:0,color:"#c8c8c8"},xaxis:{show:!1},grid:{borderWidth:0,borderColor:"#c8c8c8",color:"#c8c8c8",hoverable:!0,clickable:!0},colors:b.colors})),"pie"===g.panel.chart){var f=function(a,b){return"<div ng-click=\"build_search(panel.field,'"+a.key+'\') "style="font-size:8pt;text-align:center;padding:2px;color:white;">'+a.value+"<br/>"+Math.round(b.percent)+"%</div>"};l=d.plot(h,e,{legend:{show:!1},series:{pie:{innerRadius:g.panel.donut?.4:0,tilt:g.panel.tilt?.45:1,radius:1,show:!0,combine:{color:"#999",label:"The Rest"},stroke:{width:0},label:{show:g.panel.labels,radius:2/3,formatter:f,threshold:.1}}},grid:{hoverable:!0,clickable:!0,color:"#c8c8c8"},colors:b.colors})}h.is(":visible")&&setTimeout(function(){g.legend=l.getData(),c.isUndefined(g.dictionaryInfo)||a.forEach(g.legend,function(b,c){a.forEach(g.dictionaryInfo,function(a,c){a.key===b.label.value&&(b.label.value=a.value)})}),g.$$phase||g.$apply()})}catch(i){h.text(i)}})}var l;g.$on("render",function(){k()}),h.bind("plotclick",function(a,b,c){c&&g.build_search(g.data[c.seriesIndex])});var m=d("<div>");h.bind("plothover",function(a,b,c){if(c){var d="bar"===g.panel.chart?c.datapoint[1]:c.datapoint[1][0][1];m.html(e.query_color_dot(c.series.color,20)+" "+c.series.label.value+" ("+d.toFixed(0)+")").place_tt(b.pageX,b.pageY)}else m.remove()})}}}])});