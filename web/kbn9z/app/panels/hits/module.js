/*! kibana - v3.1.2 - 2015-12-18
 * Copyright (c) 2015 Rashid Khan; Licensed Apache License */

define("panels/hits/module",["angular","app","lodash","jquery","kbn","jquery.flot","jquery.flot.pie","html2canvas","div2png"],function(a,b,c,d,e){"use strict";var f=a.module("kibana.panels.hits",[]);b.useModule(f),f.controller("hits",["$scope","querySrv","dashboard","filterSrv",function(b,e,f,g){b.export_panel=function(a){div2png("hits")};var h=navigator.userAgent;h.indexOf("Firefox")>-1?b.browserType="Firefox":window.ActiveXObject||"ActiveXObject"in window?b.browserType="IE":b.browserType="other","IE"==b.browserType&&d("#hitsTotal").attr("style","margin-top:30px"),b.panelMeta={modals:[{description:"Inspect",icon:"icon-info-sign",partial:"app/partials/inspector.html",show:b.panel.spyable}],editorTabs:[]};var i={isFilter:!1,localFilter:"",style:{"font-size":"10pt"},arrangement:"horizontal",chart:"bar",counter_pos:"above",donut:!1,tilt:!1,labels:!0,spyable:!0,queries:{mode:"all",ids:[]}};c.defaults(b.panel,i),b.init=function(){b.hits=0,b.$on("refresh",function(){b.get_data()}),b.get_data()},b.get_data=function(d,h){delete b.panel.error,b.panelMeta.loading=!0;var i=b.panelMeta;if(0!==f.indices.length&&(1!==f.indices.length||"INDEX_MISSING"!==f.indices[0])){var j=c.isUndefined(d)?0:d,k=b.ejs.Request().indices(f.indices[j]);b.panel.queries.ids=e.idsByMode(b.panel.queries);var l=e.getQueryObjs(b.panel.queries.ids);c.each(l,function(a){var c="",d=a.query;1==b.panel.isFilter&&""!=b.panel.localFilter&&(c=a.query+" AND "+b.panel.localFilter,a.query=c);var f=b.ejs.FilteredQuery(e.toEjsObj(a),g.getBoolFilter(g.ids()));k=k.facet(b.ejs.QueryFacet(a.id).query(f)).size(0),a.query=d}),b.inspector=a.toJson(JSON.parse(k.toString()),!0);var m=k.doSearch();m.then(function(d){if(b.isShowData=!0,a.forEach(d.facets,function(a,c){0!=a.count&&(b.isShowData=!1)}),null===b.panelMeta&&(b.panelMeta=i),b.panelMeta.loading=!1,void 0===b.panel)return!1;if(0===j&&(b.hits=0,b.data=[],h=b.query_id=(new Date).getTime()),!c.isUndefined(d.error))return void(b.panel.error=b.parse_error(d.error));if(b.query_id===h){var e=0;c.each(l,function(a){var f=d.facets[a.id],g=c.isUndefined(b.data[e])||0===j?f.count:b.data[e].hits+f.count;b.hits+=f.count,b.data[e]={info:a,id:a.id,hits:g,data:[[e,g]]},e++}),b.$emit("render"),j<f.indices.length-1&&b.get_data(j+1,h)}})}},b.set_refresh=function(a){b.refresh=a},b.close_edit=function(){b.refresh&&b.get_data(),b.refresh=!1,b.$emit("render")}}]),f.directive("hitsChart",["querySrv",function(a){return{restrict:"A",link:function(b,f){function g(){f.css({height:b.panel.height||b.row.height});try{c.each(b.data,function(a){a.label=a.info.alias,a.color=a.info.color})}catch(e){return}require(["jquery.flot.pie"],function(){try{"bar"===b.panel.chart&&(b.plot=d.plot(f,b.data,{legend:{show:!1},series:{lines:{show:!1},bars:{show:!0,fill:1,barWidth:.8,horizontal:!1},shadowSize:1},yaxis:{show:!0,min:0,color:"#c8c8c8"},xaxis:{show:!1},grid:{borderWidth:0,borderColor:"#eee",color:"#eee",hoverable:!0},colors:a.colors})),"pie"===b.panel.chart&&(b.plot=d.plot(f,b.data,{legend:{show:!1},series:{pie:{innerRadius:b.panel.donut?.4:0,tilt:b.panel.tilt?.45:1,radius:1,show:!0,combine:{color:"#999",label:"The Rest"},stroke:{width:0},label:{show:b.panel.labels,radius:2/3,formatter:function(a,b){return"<div ng-click=\"build_search(panel.query.field,'"+a+'\') "style="font-size:8pt;text-align:center;padding:2px;color:white;">'+a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:.1}}},grid:{hoverable:!0,clickable:!0},colors:a.colors}))}catch(c){f.text(c)}})}b.$on("render",function(){g()});var h=d("<div>");f.bind("plothover",function(a,c,d){if(d){var f="bar"===b.panel.chart?d.datapoint[1]:d.datapoint[1][0][1];h.html(e.query_color_dot(d.series.color,20)+" "+d.series.label+" ("+f.toFixed(0)+")").place_tt(c.pageX,c.pageY)}else h.remove()})}}}])});